<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>そうまくん ToDo（単体HTML版）</title>
<style>
  :root{
    --accent:#ffd54d; /* Soma yellow */
    --accent-strong:#ffb300;
    --bg:#fffbea;
    --ink:#2a2a2a;
    --muted:#6b6b6b;
    --card:#ffffff;
    --done:#b9e6a1;
    --danger:#ff6666;
    --border:#e8e2c9;
  }
  html,body{margin:0;padding:0;font-family:"-apple-system",BlinkMacSystemFont,"Segoe UI",Roboto,"Hiragino Sans","Noto Sans JP","Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji",sans-serif;background:var(--bg);color:var(--ink)}
  header{
    position:sticky;top:0;z-index:10;
    background:linear-gradient(180deg,var(--accent),var(--accent-strong));
    color:#1a1300;padding:14px 16px 12px;border-bottom:3px solid #00000015;
  }
  header h1{margin:0;font-size:20px;letter-spacing:.5px}
  header .sub{font-size:12px;opacity:.9}
  .container{max-width:760px;margin:16px auto;padding:0 12px 80px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:0 2px 6px #0000000f;padding:12px;margin:12px 0}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  input[type="text"], textarea, select, input[type="datetime-local"]{
    width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:16px
  }
  textarea{min-height:70px;resize:vertical}
  button{
    border:none;border-radius:10px;padding:10px 14px;background:var(--accent-strong);color:#1a1300;font-weight:600;
    box-shadow:0 2px 0 #00000022;cursor:pointer
  }
  button.ghost{background:#ffffff;border:1px solid var(--border);box-shadow:none}
  button.danger{background:var(--danger);color:#fff}
  button.small{padding:6px 10px;font-size:13px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;border:1px solid var(--border);padding:6px 10px;background:#fff}
  .pill input{margin-right:6px}
  .list{display:flex;flex-direction:column;gap:8px;margin-top:6px}
  .item{
    display:flex;align-items:flex-start;gap:10px;background:#fff;border:1px solid var(--border);
    border-radius:12px;padding:10px;
  }
  .item.done{background:var(--done);opacity:.85}
  .item .main{flex:1 1 auto}
  .title{font-size:16px;font-weight:700}
  .muted{color:var(--muted);font-size:12px}
  .badges{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
  .badge{border-radius:999px;background:#f1f1f1;border:1px solid var(--border);padding:4px 8px;font-size:12px}
  .priority{font-size:14px}
  .actions{display:flex;gap:6px;align-items:center}
  .spacer{flex:1}
  .hidden{display:none !important}
  .footnote{font-size:12px;color:var(--muted);margin-top:8px}
  .search{flex:1}
  .checkbox{transform:translateY(2px);}
</style>
</head>
<body>
<header>
  <h1>そうまくんと一緒に勝ち抜く ToDo 💛🍀</h1>
  <div class="sub">単体HTML / ローカル保存 / iPhone対応</div>
</header>

<div class="container">
  <!-- 新規追加フォーム -->
  <div class="card" id="addCard">
    <div class="row">
      <input id="titleInput" type="text" inputmode="text" placeholder="やること（例：グッズ予約、チケット申し込み など）" />
      <textarea id="noteInput" placeholder="メモ（任意）"></textarea>
      <div class="row" style="gap:8px">
        <select id="priorityInput" aria-label="優先度">
          <option value="high">💛 高</option>
          <option value="mid" selected>🍀 中</option>
          <option value="low">低</option>
        </select>
        <input id="dueInput" type="datetime-local" />
        <button id="addBtn">＋ 追加</button>
      </div>
    </div>
    <div class="footnote">＊データはこの端末のブラウザ（localStorage）に保存されます。LINE共有用の「エクスポート」もあるよ。</div>
  </div>

  <!-- ツールバー -->
  <div class="card">
    <div class="toolbar">
      <input id="searchInput" class="search" type="text" placeholder="🔎 検索（タイトル・メモ）" />
      <div class="pill"><label><input type="checkbox" id="showDone" checked> 完了も表示</label></div>
      <select id="sortSelect" class="pill">
        <option value="created">並び：作成順</option>
        <option value="due">並び：期限が近い順</option>
        <option value="prio">並び：優先度</option>
      </select>
      <button id="exportBtn" class="ghost">⬇ エクスポート</button>
      <button id="importBtn" class="ghost">⬆ インポート</button>
      <button id="clearDoneBtn" class="danger small">完了を一括削除</button>
    </div>
  </div>

  <!-- 一覧 -->
  <div class="list" id="list"></div>

  <!-- インポート／エクスポートエリア -->
  <div class="card hidden" id="ioCard">
    <div class="row">
      <textarea id="ioText" placeholder="ここに貼り付ける／ここからコピー"></textarea>
      <div class="row">
        <button id="copyBtn">コピー</button>
        <button id="loadBtn">読み込み</button>
        <button id="closeIoBtn" class="ghost">閉じる</button>
      </div>
      <div class="footnote">他の端末とやり取りする時は、このテキストをコピーしてLINEなどで共有してね。</div>
    </div>
  </div>

</div>

<script>
(function(){
  const STORAGE_KEY = "somaTodoV1";
  /** @type {Array<{id:string,title:string,note:string,prio:'high'|'mid'|'low',done:boolean,created:number,due?:number}>} */
  let tasks = [];
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // Elements
  const titleInput = $("#titleInput");
  const noteInput = $("#noteInput");
  const priorityInput = $("#priorityInput");
  const dueInput = $("#dueInput");
  const addBtn = $("#addBtn");
  const listEl = $("#list");
  const searchInput = $("#searchInput");
  const showDone = $("#showDone");
  const sortSelect = $("#sortSelect");
  const exportBtn = $("#exportBtn");
  const importBtn = $("#importBtn");
  const ioCard = $("#ioCard");
  const ioText = $("#ioText");
  const copyBtn = $("#copyBtn");
  const loadBtn = $("#loadBtn");
  const closeIoBtn = $("#closeIoBtn");
  const clearDoneBtn = $("#clearDoneBtn");

  function save(){
    try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks)); }
    catch(e){ alert("保存に失敗しました（容量オーバーかも）"); }
  }
  function load(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      tasks = raw ? JSON.parse(raw) : [];
    }catch(e){ tasks = []; }
  }
  function uid(){ return Math.random().toString(36).slice(2,10)+Date.now().toString(36); }

  function prioIcon(p){
    if(p==="high") return "💛 高";
    if(p==="mid") return "🍀 中";
    return "低";
  }
  function prioOrder(p){
    return p==="high" ? 0 : p==="mid" ? 1 : 2;
  }

  function render(){
    const q = searchInput.value.trim().toLowerCase();
    const showCompleted = showDone.checked;
    const sort = sortSelect.value;

    let view = tasks.filter(t => (showCompleted || !t.done));
    if(q){
      view = view.filter(t =>
        (t.title||"").toLowerCase().includes(q) ||
        (t.note||"").toLowerCase().includes(q)
      );
    }
    if(sort==="due"){
      view.sort((a,b)=> (a.due||Infinity) - (b.due||Infinity));
    }else if(sort==="prio"){
      view.sort((a,b)=> prioOrder(a.prio) - prioOrder(b.prio) || (a.due||Infinity)-(b.due||Infinity));
    }else{
      view.sort((a,b)=> a.created - b.created);
    }

    listEl.innerHTML = "";
    if(view.length===0){
      const empty = document.createElement("div");
      empty.className="card";
      empty.textContent = "まだタスクがないよ。上のフォームから追加してね。";
      listEl.appendChild(empty);
      return;
    }

    for(const t of view){
      const item = document.createElement("div");
      item.className = "item"+(t.done?" done":"");
      item.dataset.id = t.id;

      const check = document.createElement("input");
      check.type = "checkbox"; check.className="checkbox";
      check.checked = !!t.done;
      check.addEventListener("change", () => { t.done = check.checked; save(); render(); });

      const main = document.createElement("div");
      main.className="main";
      const title = document.createElement("div");
      title.className="title";
      title.textContent = t.title || "(無題)";
      const meta = document.createElement("div");
      meta.className="muted";
      const badges = document.createElement("div");
      badges.className="badges";
      const bPrio = document.createElement("span");
      bPrio.className="badge priority";
      bPrio.textContent = prioIcon(t.prio || "low");
      badges.appendChild(bPrio);

      if(t.due){
        const d = new Date(t.due);
        const bDue = document.createElement("span");
        bDue.className="badge";
        bDue.textContent = "期限: " + formatDateTime(d);
        badges.appendChild(bDue);
      }
      const bCreated = document.createElement("span");
      bCreated.className="badge";
      bCreated.textContent = "作成: " + formatDateTime(new Date(t.created));
      badges.appendChild(bCreated);

      if(t.note){
        const note = document.createElement("div");
        note.className="muted";
        note.textContent = t.note;
        main.appendChild(note);
      }
      main.prepend(title);
      main.appendChild(badges);

      const actions = document.createElement("div");
      actions.className="actions";
      const up = btn("▲", "small ghost", () => move(t.id,-1));
      const down = btn("▼", "small ghost", () => move(t.id, +1));
      const edit = btn("編集", "small ghost", () => editItem(t.id));
      const del = btn("削除", "small danger", () => remove(t.id));
      actions.append(up,down,edit,del);

      item.append(check, main, actions);
      listEl.appendChild(item);
    }
  }

  function btn(label, klass, onclick){
    const b=document.createElement("button");
    b.textContent=label; b.className=klass; b.addEventListener("click",onclick,{passive:true});
    return b;
  }

  function move(id,dir){
    const idx = tasks.findIndex(t=>t.id===id);
    if(idx<0) return;
    const j = idx+dir;
    if(j<0 || j>=tasks.length) return;
    const tmp = tasks[idx]; tasks[idx]=tasks[j]; tasks[j]=tmp;
    save(); render();
  }

  function remove(id){
    if(!confirm("このタスクを削除しますか？")) return;
    tasks = tasks.filter(t=>t.id!==id);
    save(); render();
  }

  function editItem(id){
    const t = tasks.find(x=>x.id===id);
    if(!t) return;
    const title = prompt("タイトルを編集", t.title || "");
    if(title===null) return;
    const note = prompt("メモを編集（空でもOK）", t.note || "");
    let prio = prompt("優先度を入力: high(💛) / mid(🍀) / low", t.prio);
    if(prio!== "high" && prio!=="mid" && prio!=="low") prio = t.prio;
    const dueStr = prompt("期限（YYYY-MM-DD HH:mm 形式 / 空でOK）", t.due? formatForInput(new Date(t.due)).replace("T"," ") : "");
    let due = t.due;
    if(dueStr && dueStr.trim()){
      const parsed = parseLooseDateTime(dueStr.trim());
      if(parsed) due = +parsed;
    }else{
      due = undefined;
    }
    t.title = (title||"").trim();
    t.note = (note||"").trim();
    t.prio = prio;
    t.due = due;
    save(); render();
  }

  function formatDateTime(d){
    const y=d.getFullYear();
    const m=("0"+(d.getMonth()+1)).slice(-2);
    const da=("0"+d.getDate()).slice(-2);
    const hh=("0"+d.getHours()).slice(-2);
    const mm=("0"+d.getMinutes()).slice(-2);
    return `${y}/${m}/${da} ${hh}:${mm}`;
  }
  function formatForInput(d){
    const y=d.getFullYear();
    const m=("0"+(d.getMonth()+1)).slice(-2);
    const da=("0"+d.getDate()).slice(-2);
    const hh=("0"+d.getHours()).slice(-2);
    const mm=("0"+d.getMinutes()).slice(-2);
    return `${y}-${m}-${da}T${hh}:${mm}`;
  }
  function parseLooseDateTime(s){
    // Accept "YYYY-MM-DD HH:mm" or "YYYY/MM/DD HH:mm" or with T
    const t = s.replace("T"," ").replace(/\//g,"-").trim();
    const m = t.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2})$/);
    if(!m) return null;
    const d = new Date(+m[1], +m[2]-1, +m[3], +m[4], +m[5]);
    return isNaN(+d)? null : d;
  }

  // Add new
  function add(){
    const title = (titleInput.value||"").trim();
    const note = (noteInput.value||"").trim();
    const prio = /** @type any */ (priorityInput.value||"mid");
    const due = dueInput.value ? +new Date(dueInput.value) : undefined;
    if(!title){
      alert("タイトルを入力してね"); titleInput.focus(); return;
    }
    tasks.push({id:uid(), title, note, prio, due, done:false, created:Date.now()});
    titleInput.value=""; noteInput.value=""; priorityInput.value="mid"; dueInput.value="";
    save(); render();
  }

  addBtn.addEventListener("click", add);
  titleInput.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); add(); } });
  searchInput.addEventListener("input", render);
  showDone.addEventListener("change", render);
  sortSelect.addEventListener("change", render);

  // Export / Import
  exportBtn.addEventListener("click", ()=>{
    const obj = {app:"soma-todo", version:1, exportedAt:Date.now(), tasks};
    const json = JSON.stringify(obj, null, 2);
    ioText.value = json;
    ioCard.classList.remove("hidden");
    // try clipboard
    if(navigator.clipboard && window.isSecureContext){
      navigator.clipboard.writeText(json).catch(()=>{});
    }
  });
  importBtn.addEventListener("click", ()=>{
    ioCard.classList.remove("hidden");
    ioText.placeholder = "ここにエクスポートJSONを貼り付けて「読み込み」";
  });
  copyBtn.addEventListener("click", ()=>{
    ioText.select(); document.execCommand("copy");
  });
  loadBtn.addEventListener("click", ()=>{
    let obj=null;
    try{ obj = JSON.parse(ioText.value); }catch(e){ alert("JSONの形式が正しくないかも"); return; }
    if(!obj || obj.app!=="soma-todo" || !Array.isArray(obj.tasks)){ alert("対応していないデータです"); return; }
    if(!confirm("現在のタスクを上書きします。よろしいですか？")) return;
    tasks = obj.tasks.map(t=>({ ...t, created: t.created||Date.now() }));
    save(); render(); ioCard.classList.add("hidden");
  });
  closeIoBtn.addEventListener("click", ()=> ioCard.classList.add("hidden"));
  clearDoneBtn.addEventListener("click", ()=>{
    if(!confirm("完了済みタスクをすべて削除しますか？")) return;
    tasks = tasks.filter(t=>!t.done); save(); render();
  });

  // Bootstrap
  load(); render();
})();
</script>
</body>
</html>
